{"version":3,"file":"wd-form.D-5d91qu.js","sources":["../../../../src/uni_modules/wot-design-uni/components/wd-form/wd-form.vue"],"sourcesContent":["<template>\n  <view :class=\"`wd-form ${customClass}`\" :style=\"customStyle\">\n    <slot></slot>\n    <wd-toast v-if=\"props.errorType === 'toast'\" selector=\"wd-form-toast\" />\n  </view>\n</template>\n\n<script lang=\"ts\">\nexport default {\n  name: 'wd-form',\n  options: {\n    addGlobalClass: true,\n    virtualHost: true,\n    styleIsolation: 'shared'\n  }\n}\n</script>\n\n<script lang=\"ts\" setup>\nimport wdToast from '../wd-toast/wd-toast.vue'\nimport { reactive, watch } from 'vue'\nimport { deepClone, getPropByPath, isArray, isDef, isPromise, isString } from '../common/util'\nimport { useChildren } from '../composables/useChildren'\nimport { useToast } from '../wd-toast'\nimport { type FormRules, FORM_KEY, type ErrorMessage, formProps, type FormExpose } from './types'\n\nconst { show: showToast } = useToast('wd-form-toast')\nconst props = defineProps(formProps)\n\nconst { children, linkChildren } = useChildren(FORM_KEY)\nlet errorMessages = reactive<Record<string, string>>({})\n\nlinkChildren({ props, errorMessages })\n\nwatch(\n  () => props.model,\n  () => {\n    if (props.resetOnChange) {\n      clearMessage()\n    }\n  },\n  { immediate: true, deep: true }\n)\n\n/**\n * 表单校验\n * @param prop 指定校验字段或字段数组\n */\nasync function validate(prop?: string | string[]): Promise<{ valid: boolean; errors: ErrorMessage[] }> {\n  const errors: ErrorMessage[] = []\n  let valid: boolean = true\n  const promises: Promise<void>[] = []\n  const formRules: FormRules = getMergeRules()\n  const propsToValidate = isArray(prop) ? prop : isDef(prop) ? [prop] : []\n  const rulesToValidate: FormRules =\n    propsToValidate.length > 0\n      ? propsToValidate.reduce((acc, key) => {\n          if (formRules[key]) {\n            acc[key] = formRules[key]\n          }\n          return acc\n        }, {} as FormRules)\n      : formRules\n\n  for (const propName in rulesToValidate) {\n    const rules = rulesToValidate[propName]\n    const value = getPropByPath(props.model, propName)\n\n    if (rules && rules.length > 0) {\n      for (const rule of rules) {\n        if (rule.required && (!isDef(value) || value === '')) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        if (rule.pattern && !rule.pattern.test(value)) {\n          errors.push({\n            prop: propName,\n            message: rule.message\n          })\n          valid = false\n          break\n        }\n        const { validator, ...ruleWithoutValidator } = rule\n        if (validator) {\n          const result = validator(value, ruleWithoutValidator)\n          if (isPromise(result)) {\n            promises.push(\n              result\n                .then((res) => {\n                  if (typeof res === 'string') {\n                    errors.push({\n                      prop: propName,\n                      message: res\n                    })\n                    valid = false\n                  } else if (typeof res === 'boolean' && !res) {\n                    errors.push({\n                      prop: propName,\n                      message: rule.message\n                    })\n                    valid = false\n                  }\n                })\n                .catch((error?: string | Error) => {\n                  const message = isDef(error) ? (isString(error) ? error : error.message || rule.message) : rule.message\n                  errors.push({ prop: propName, message })\n                  valid = false\n                })\n            )\n          } else {\n            if (!result) {\n              errors.push({\n                prop: propName,\n                message: rule.message\n              })\n              valid = false\n            }\n          }\n        }\n      }\n    }\n  }\n\n  await Promise.all(promises)\n\n  showMessage(errors)\n\n  if (valid) {\n    if (propsToValidate.length) {\n      propsToValidate.forEach(clearMessage)\n    } else {\n      clearMessage()\n    }\n  }\n\n  return {\n    valid,\n    errors\n  }\n}\n\n// 合并子组件的rules到父组件的rules\nfunction getMergeRules() {\n  const mergedRules: FormRules = deepClone(props.rules)\n  const childrenProps = children.map((child) => child.prop)\n\n  // 过滤掉在 children 中不存在对应子组件的规则\n  Object.keys(mergedRules).forEach((key) => {\n    if (!childrenProps.includes(key)) {\n      delete mergedRules[key]\n    }\n  })\n\n  children.forEach((item) => {\n    if (isDef(item.prop) && isDef(item.rules) && item.rules.length) {\n      if (mergedRules[item.prop]) {\n        mergedRules[item.prop] = [...mergedRules[item.prop], ...item.rules]\n      } else {\n        mergedRules[item.prop] = item.rules\n      }\n    }\n  })\n  return mergedRules\n}\n\nfunction showMessage(errors: ErrorMessage[]) {\n  const childrenProps = children.map((e) => e.prop).filter(Boolean)\n  const messages = errors.filter((error) => error.message && childrenProps.includes(error.prop))\n  if (messages.length) {\n    messages.sort((a, b) => {\n      return childrenProps.indexOf(a.prop) - childrenProps.indexOf(b.prop)\n    })\n    if (props.errorType === 'toast') {\n      showToast(messages[0].message)\n    } else if (props.errorType === 'message') {\n      messages.forEach((error) => {\n        errorMessages[error.prop] = error.message\n      })\n    }\n  }\n}\n\nfunction clearMessage(prop?: string) {\n  if (prop) {\n    errorMessages[prop] = ''\n  } else {\n    Object.keys(errorMessages).forEach((key) => {\n      errorMessages[key] = ''\n    })\n  }\n}\n\n/**\n * 重置表单项的验证提示\n */\nfunction reset() {\n  clearMessage()\n}\n\ndefineExpose<FormExpose>({ validate, reset })\n</script>\n\n<style lang=\"scss\" scoped>\n@import './index.scss';\n</style>\n"],"names":["name","options","addGlobalClass","virtualHost","styleIsolation","show","showToast","useToast","props","__props","children","linkChildren","useChildren","FORM_KEY","errorMessages","reactive","clearMessage","prop","Object","keys","forEach","key","watch","model","resetOnChange","immediate","deep","__expose","validate","this","errors","valid","promises","formRules","mergedRules","deepClone","rules","childrenProps","map","child","includes","item","isDef","length","getMergeRules","propsToValidate","isArray","rulesToValidate","reduce","acc","propName","value","getPropByPath","rule","required","push","message","pattern","test","_a","validator","ruleWithoutValidator","__objRest","result","isPromise","then","res","catch","error","isString","Promise","all","e","filter","Boolean","messages","sort","a","b","indexOf","errorType","showMessage","reset"],"mappings":"kuBAQA,oIAAe,CACbA,KAAM,UACNC,QAAS,CACPC,gBAAgB,EAChBC,aAAa,EACbC,eAAgB,2CAapB,MAAQC,KAAMC,GAAcC,EAAS,iBAC/BC,EAAQC,GAERC,SAAEA,EAAAC,aAAUA,GAAiBC,EAAYC,GAC/C,IAAIC,EAAgBC,EAAiC,IA4JrD,SAASC,EAAaC,GAChBA,EACFH,EAAcG,GAAQ,GAEtBC,OAAOC,KAAKL,GAAeM,QAASC,IAClCP,EAAcO,GAAO,IAEzB,QAjKFV,EAAa,CAAEH,QAAOM,kBAEtBQ,EACE,IAAMd,EAAMe,MACZ,KACMf,EAAMgB,eACRR,KAGJ,CAAES,WAAW,EAAMC,MAAM,IAkK3BC,EAAyB,CAAEC,SA3J3B,SAAwBX,GAA+E,SAAAY,OAAA,OAAA,YACrG,MAAMC,EAAyB,GAC/B,IAAIC,GAAiB,EACrB,MAAMC,EAA4B,GAC5BC,EA8FR,WACE,MAAMC,EAAyBC,EAAU3B,EAAM4B,OACzCC,EAAgB3B,EAAS4B,IAAKC,GAAUA,EAAMtB,MAkBpD,OAfAC,OAAOC,KAAKe,GAAad,QAASC,IAC3BgB,EAAcG,SAASnB,WACnBa,EAAYb,KAIvBX,EAASU,QAASqB,IACZC,EAAMD,EAAKxB,OAASyB,EAAMD,EAAKL,QAAUK,EAAKL,MAAMO,SAClDT,EAAYO,EAAKxB,MACnBiB,EAAYO,EAAKxB,MAAQ,IAAIiB,EAAYO,EAAKxB,SAAUwB,EAAKL,OAE7DF,EAAYO,EAAKxB,MAAQwB,EAAKL,SAI7BF,CAAA,CAlHsBU,GACvBC,EAAkBC,EAAQ7B,GAAQA,EAAOyB,EAAMzB,GAAQ,CAACA,GAAQ,GAChE8B,EACJF,EAAgBF,OAAS,EACrBE,EAAgBG,OAAO,CAACC,EAAK5B,KACvBY,EAAUZ,KACZ4B,EAAI5B,GAAOY,EAAUZ,IAEhB4B,GACN,CAAA,GACHhB,EAEN,IAAA,MAAWiB,KAAYH,EAAiB,CACtC,MAAMX,EAAQW,EAAgBG,GACxBC,EAAQC,EAAc5C,EAAMe,MAAO2B,GAEzC,GAAId,GAASA,EAAMO,OAAS,EAC1B,IAAA,MAAWU,KAAQjB,EAAO,CACxB,GAAIiB,EAAKC,YAAcZ,EAAMS,IAAoB,KAAVA,GAAe,CACpDrB,EAAOyB,KAAK,CACVtC,KAAMiC,EACNM,QAASH,EAAKG,UAEhBzB,GAAQ,EACR,KAAA,CAEF,GAAIsB,EAAKI,UAAYJ,EAAKI,QAAQC,KAAKP,GAAQ,CAC7CrB,EAAOyB,KAAK,CACVtC,KAAMiC,EACNM,QAASH,EAAKG,UAEhBzB,GAAQ,EACR,KAAA,CAEF,MAA+C4B,KAAvCC,UAAAA,GAAuCD,EAAzBE,EAAAC,EAAyBH,EAAzB,CAAd,cACR,GAAIC,EAAW,CACb,MAAMG,EAASH,EAAUT,EAAOU,GAC5BG,EAAUD,GACZ/B,EAASuB,KACPQ,EACGE,KAAMC,IACc,iBAARA,GACTpC,EAAOyB,KAAK,CACVtC,KAAMiC,EACNM,QAASU,IAEXnC,GAAQ,GACgB,kBAARmC,GAAsBA,IACtCpC,EAAOyB,KAAK,CACVtC,KAAMiC,EACNM,QAASH,EAAKG,UAEhBzB,GAAQ,KAGXoC,MAAOC,IACN,MAAMZ,EAAUd,EAAM0B,GAAUC,EAASD,GAASA,EAAQA,EAAMZ,SAAWH,EAAKG,QAAWH,EAAKG,QAChG1B,EAAOyB,KAAK,CAAEtC,KAAMiC,EAAUM,YAC9BzB,GAAQ,KAITgC,IACHjC,EAAOyB,KAAK,CACVtC,KAAMiC,EACNM,QAASH,EAAKG,UAEhBzB,GAAQ,EAEZ,CACF,CAEJ,CAeF,aAZMuC,QAAQC,IAAIvC,GA0CpB,SAAqBF,GACnB,MAAMO,EAAgB3B,EAAS4B,IAAKkC,GAAMA,EAAEvD,MAAMwD,OAAOC,SACnDC,EAAW7C,EAAO2C,OAAQL,GAAUA,EAAMZ,SAAWnB,EAAcG,SAAS4B,EAAMnD,OACpF0D,EAAShC,SACXgC,EAASC,KAAK,CAACC,EAAGC,IACTzC,EAAc0C,QAAQF,EAAE5D,MAAQoB,EAAc0C,QAAQD,EAAE7D,OAEzC,UAApBT,EAAMwE,UACR1E,EAAUqE,EAAS,GAAGnB,SACO,YAApBhD,EAAMwE,WACfL,EAASvD,QAASgD,IAChBtD,EAAcsD,EAAMnD,MAAQmD,EAAMZ,UAGxC,CAtDAyB,CAAYnD,GAERC,IACEc,EAAgBF,OAClBE,EAAgBzB,QAAQJ,GAExBA,KAIG,CACLe,QACAD,SACF,yMAAA,EA6DmCoD,MAJrC,WACElE,GAAa"}