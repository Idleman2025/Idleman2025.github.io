{"version":3,"file":"useChildren.En5eoaK3.js","sources":["../../../../src/uni_modules/wot-design-uni/components/composables/useChildren.ts"],"sourcesContent":["import {\n  provide,\n  reactive,\n  getCurrentInstance,\n  type VNode,\n  type InjectionKey,\n  type VNodeNormalizedChildren,\n  type ComponentPublicInstance,\n  type ComponentInternalInstance\n} from 'vue'\n\n// 小程序端不支持从vue导出的isVNode方法，参考uni-mp-vue的实现\nfunction isVNode(value: any): value is VNode {\n  return value ? value.__v_isVNode === true : false\n}\n\nexport function flattenVNodes(children: VNodeNormalizedChildren) {\n  const result: VNode[] = []\n\n  const traverse = (children: VNodeNormalizedChildren) => {\n    if (Array.isArray(children)) {\n      children.forEach((child) => {\n        if (isVNode(child)) {\n          result.push(child)\n\n          if (child.component?.subTree) {\n            result.push(child.component.subTree)\n            traverse(child.component.subTree.children)\n          }\n\n          if (child.children) {\n            traverse(child.children)\n          }\n        }\n      })\n    }\n  }\n\n  traverse(children)\n\n  return result\n}\n\nconst findVNodeIndex = (vnodes: VNode[], vnode: VNode) => {\n  const index = vnodes.indexOf(vnode)\n  if (index === -1) {\n    return vnodes.findIndex((item) => vnode.key !== undefined && vnode.key !== null && item.type === vnode.type && item.key === vnode.key)\n  }\n  return index\n}\n\n// sort children instances by vnodes order\nexport function sortChildren(\n  parent: ComponentInternalInstance,\n  publicChildren: ComponentPublicInstance[],\n  internalChildren: ComponentInternalInstance[]\n) {\n  const vnodes = parent && parent.subTree && parent.subTree.children ? flattenVNodes(parent.subTree.children) : []\n\n  internalChildren.sort((a, b) => findVNodeIndex(vnodes, a.vnode) - findVNodeIndex(vnodes, b.vnode))\n\n  const orderedPublicChildren = internalChildren.map((item) => item.proxy!)\n\n  publicChildren.sort((a, b) => {\n    const indexA = orderedPublicChildren.indexOf(a)\n    const indexB = orderedPublicChildren.indexOf(b)\n    return indexA - indexB\n  })\n}\n\nexport function useChildren<\n  // eslint-disable-next-line\n  Child extends ComponentPublicInstance = ComponentPublicInstance<{}, any>,\n  ProvideValue = never\n>(key: InjectionKey<ProvideValue>) {\n  const publicChildren: Child[] = reactive([])\n  const internalChildren: ComponentInternalInstance[] = reactive([])\n  const parent = getCurrentInstance()!\n\n  const linkChildren = (value?: ProvideValue) => {\n    const link = (child: ComponentInternalInstance) => {\n      if (child.proxy) {\n        internalChildren.push(child)\n        publicChildren.push(child.proxy as Child)\n        sortChildren(parent, publicChildren, internalChildren)\n      }\n    }\n\n    const unlink = (child: ComponentInternalInstance) => {\n      const index = internalChildren.indexOf(child)\n      publicChildren.splice(index, 1)\n      internalChildren.splice(index, 1)\n    }\n\n    provide(\n      key,\n      Object.assign(\n        {\n          link,\n          unlink,\n          children: publicChildren,\n          internalChildren\n        },\n        value\n      )\n    )\n  }\n\n  return {\n    children: publicChildren,\n    linkChildren\n  }\n}\n"],"names":["findVNodeIndex","vnodes","vnode","index","indexOf","findIndex","item","key","type","sortChildren","parent","publicChildren","internalChildren","subTree","children","result","traverse","Array","isArray","forEach","child","value","__v_isVNode","push","_a","component","flattenVNodes","sort","a","b","orderedPublicChildren","map","proxy","useChildren","reactive","getCurrentInstance","linkChildren","provide","Object","assign","link","unlink","splice"],"mappings":"uDA2CA,MAAMA,EAAiB,CAACC,EAAiBC,KACvC,MAAMC,EAAQF,EAAOG,QAAQF,GAC7B,OAAc,IAAVC,EACKF,EAAOI,UAAWC,QAAuB,IAAdJ,EAAMK,KAAmC,OAAdL,EAAMK,KAAgBD,EAAKE,OAASN,EAAMM,MAAQF,EAAKC,MAAQL,EAAMK,KAE7HJ,GAIF,SAASM,EACdC,EACAC,EACAC,GAEA,MAAMX,EAASS,GAAUA,EAAOG,SAAWH,EAAOG,QAAQC,SAzCrD,SAAuBA,GAC5B,MAAMC,EAAkB,GAElBC,EAAYF,IACZG,MAAMC,QAAQJ,IAChBA,EAASK,QAASC,UATPC,KAUGD,KATmB,IAAtBC,EAAMC,cAUbP,EAAOQ,KAAKH,IAER,OAAAI,EAAAJ,EAAMK,gBAAN,EAAAD,EAAiBX,WACnBE,EAAOQ,KAAKH,EAAMK,UAAUZ,SAC5BG,EAASI,EAAMK,UAAUZ,QAAQC,WAG/BM,EAAMN,UACRE,EAASI,EAAMN,cASzB,OAFAE,EAASF,GAEFC,CACT,CAgBuEW,CAAchB,EAAOG,QAAQC,UAAY,GAE9GF,EAAiBe,KAAK,CAACC,EAAGC,IAAM7B,EAAeC,EAAQ2B,EAAE1B,OAASF,EAAeC,EAAQ4B,EAAE3B,QAE3F,MAAM4B,EAAwBlB,EAAiBmB,IAAKzB,GAASA,EAAK0B,OAElErB,EAAegB,KAAK,CAACC,EAAGC,IACPC,EAAsB1B,QAAQwB,GAC9BE,EAAsB1B,QAAQyB,GAGjD,CAEO,SAASI,EAId1B,GACA,MAAMI,EAA0BuB,EAAS,IACnCtB,EAAgDsB,EAAS,IACzDxB,EAASyB,IA+Bf,MAAO,CACLrB,SAAUH,EACVyB,aA/BoBf,IAepBgB,EACE9B,EACA+B,OAAOC,OACL,CACEC,KAlBQpB,IACRA,EAAMY,QACRpB,EAAiBW,KAAKH,GACtBT,EAAeY,KAAKH,EAAMY,OAC1BvB,EAAaC,EAAQC,EAAgBC,KAenC6B,OAXUrB,IACd,MAAMjB,EAAQS,EAAiBR,QAAQgB,GACvCT,EAAe+B,OAAOvC,EAAO,GAC7BS,EAAiB8B,OAAOvC,EAAO,IAS3BW,SAAUH,EACVC,oBAEFS,KASR"}